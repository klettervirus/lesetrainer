<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blitzlesen-Trainer v43</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 0.7s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>
    <input type="file" id="csvUpload" accept=".csv,.txt" style="display:none">
    
    <script>
// === KONSTANTEN ===
const SYLLABLE_DECAY = 0.8;
const DEFAULT_WORDS = ["Haus","Sonne","Blume","Katze","Hund","Baum","Tisch","Stuhl","Buch","Auto","Fenster","Garten","Regen","Wolke","Stern","Vogel","Fisch","Pferd","Apfel","Birne","Erdbeere","Banane","Orange","Tomate","Gurke","Blumentopf","Regenbogen","Schmetterling","Spielplatz","Fahrrad","Computer","Telefon","Tasche","Schere","Klebstoff","Freundschaft","Geburtstag","Weihnachten","Ostern","Ferien","Schwimmbad","Turnhalle","Klassenzimmer","Pausenhof","Bibliothek","Abenteuer","Geschichte","MÃ¤rchen","Dinosaurier","Roboter"];
const ANTI_RATEN = ["deine","deiner","deines","Hund","Hunde","Buch","BÃ¼cher","Hand","HÃ¤nde","der","die","das","den","denen","des","dies","dessen","denn","Daten","davon"];
const SINGULAR_PLURAL = ["Schiffe","Schiff","Hosen","Hose","Garten","Lieder","Lied","Tische","Tisch","Pflanzen","Pflanze","Papiere","Papier","Namen","Name","Schwestern","Schwester","Zahl","Zahlen","TÃ¼ten","TÃ¼te","HÃ¤user","Haus","Taschen","Tasche","SÃ¤tze","Satz","Platz","PlÃ¤tze","SchÃ¼sseln","SchÃ¼ssel","Kreise","Kreis","Wiese","Wiesen","Schuhe","Schuh","Kinder","Kind","KÃ¶pfe","Kopf","MÃ¤nner","Mann","Haare","Haar"];

// === STATE ===
let state = {
    screen: 'start',
    settings: {baseDuration: 250, shuffle: true, adaptiveSpeed: true, adaptiveThreshold: 2, adaptiveStep: 10, requireTyping: false},
    lists: [
        {id:'default',name:'Standard-Wortliste',words:DEFAULT_WORDS,isDefault:true},
        {id:'anti-raten',name:'Anti Raten',words:ANTI_RATEN,isDefault:false},
        {id:'singular-plural',name:'Singular/Plural',words:SINGULAR_PLURAL,isDefault:false}
    ],
    activeListId: 'default',
    showListMgr: false,
    newListName: '',
    session: null,
    idx: 0,
    countdown: null,
    showWord: false,
    showBtns: false,
    paused: false,
    results: [],
    history: JSON.parse(localStorage.getItem('blitzlesen-history')||'[]'),
    consCorrect: 0,
    consWrong: 0,
    curDur: 250,
    typed: '',
    feedback: null
};

const saved = localStorage.getItem('blitzlesen-wordlists');
if(saved) state.lists = JSON.parse(saved);
const savedActive = localStorage.getItem('blitzlesen-active-list');
if(savedActive) state.activeListId = savedActive;

// === HILFSFUNKTIONEN ===
const calcTime = (syl, base) => base * 5 * (1 - Math.pow(SYLLABLE_DECAY, syl));
const getTier = d => {
    if(d<=100) return {n:'Gepard',e:'ğŸ†',c:'from-yellow-400 to-orange-500',l:'Blitzschnell!'};
    if(d<=150) return {n:'Hase',e:'ğŸ°',c:'from-green-400 to-emerald-500',l:'Super schnell!'};
    if(d<=200) return {n:'Pferd',e:'ğŸ´',c:'from-blue-400 to-cyan-500',l:'Schnell!'};
    if(d<=250) return {n:'Fuchs',e:'ğŸ¦Š',c:'from-orange-400 to-red-500',l:'Flink!'};
    if(d<=300) return {n:'Katze',e:'ğŸˆ',c:'from-purple-400 to-pink-500',l:'Geschickt!'};
    if(d<=350) return {n:'EichhÃ¶rnchen',e:'ğŸ¿ï¸',c:'from-amber-400 to-orange-400',l:'Munter!'};
    if(d<=400) return {n:'Igel',e:'ğŸ¦”',c:'from-yellow-300 to-amber-400',l:'GemÃ¼tlich'};
    if(d<=450) return {n:'Ente',e:'ğŸ¦†',c:'from-blue-300 to-teal-400',l:'Entspannt'};
    return {n:'Koala',e:'ğŸ¨',c:'from-gray-300 to-slate-400',l:'Ganz ruhig'};
};
const countSyl = w => {
    const v = w.toLowerCase().replace(/[^a-zÃ¤Ã¶Ã¼ÃŸ]/g,'').match(/[aeiouÃ¤Ã¶Ã¼y]+/g);
    return v ? v.length : 1;
};
const procWords = wl => wl.map(w => ({text:w, syllables:countSyl(w)}));
const shuffle = a => {
    const s = [...a];
    for(let i=s.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [s[i],s[j]] = [s[j],s[i]];
    }
    return s;
};
const parse = t => t.split('\n').map(w=>w.trim()).filter(w=>w.length>0);
const getActive = () => state.lists.find(l=>l.id===state.activeListId)||state.lists[0];

// === SESSION FUNKTIONEN ===
function startSession() {
    const words = state.settings.shuffle ? shuffle(procWords(getActive().words)) : procWords(getActive().words);
    state.session = {words, startTime: new Date().toISOString(), initialBaseDuration: state.settings.baseDuration, listName: getActive().name};
    state.idx = 0;
    state.results = [];
    state.consCorrect = 0;
    state.consWrong = 0;
    state.curDur = state.settings.baseDuration;
    state.screen = 'training';
    state.paused = false;
    render();
    startCountdown();
}

function startCountdown() {
    state.countdown = 3;
    state.showWord = false;
    state.showBtns = false;
    state.feedback = null;
    render();
    runCountdown();
}

function runCountdown() {
    if(state.paused) return;
    if(state.countdown > 0) {
        setTimeout(() => {
            state.countdown--;
            render();
            runCountdown();
        }, 700);
    } else {
        showCurrentWord();
    }
}

function showCurrentWord() {
    state.countdown = null;
    state.showWord = true;
    state.typed = '';
    render();
    const word = state.session.words[state.idx];
    const displayTime = calcTime(word.syllables, state.curDur);
    setTimeout(() => {
        if(!state.paused && state.screen === 'training') {
            state.showWord = false;
            state.showBtns = true;
            render();
        }
    }, displayTime);
}

function handleAnswer(correct) {
    state.results.push({word: state.session.words[state.idx].text, correct, baseDuration: state.curDur, syllables: state.session.words[state.idx].syllables});
    
    if(state.settings.adaptiveSpeed) {
        if(correct) {
            state.consCorrect++;
            state.consWrong = 0;
            if(state.consCorrect >= state.settings.adaptiveThreshold && state.curDur > 50) {
                const delta = state.curDur < 120 ? state.settings.adaptiveStep * 0.5 : state.settings.adaptiveStep;
                state.curDur = Math.max(50, state.curDur - delta);
                state.consCorrect = 0;
            }
        } else {
            state.consWrong++;
            state.consCorrect = 0;
            if(state.consWrong >= state.settings.adaptiveThreshold && state.curDur < 500) {
                const delta = state.curDur < 120 ? state.settings.adaptiveStep * 0.5 : state.settings.adaptiveStep;
                state.curDur = Math.min(500, state.curDur + delta);
                state.consWrong = 0;
            }
        }
    }
    
    if(state.idx < state.session.words.length - 1) {
        state.idx++;
        state.showBtns = false;
        render();
        startCountdown();
    } else {
        finishSession();
    }
}

function handleTypedSubmit() {
    const correctWord = state.session.words[state.idx].text.toLowerCase();
    const userWord = state.typed.trim().toLowerCase();
    const isCorrect = userWord === correctWord;
    state.feedback = isCorrect ? 'correct' : 'wrong';
    render();
    setTimeout(() => {
        state.feedback = null;
        handleAnswer(isCorrect);
    }, 1000);
}

function finishSession() {
    const correct = state.results.filter(r=>r.correct).length;
    const total = state.results.length;
    const accuracy = Math.round((correct/total)*100);
    const bySyllables = {};
    state.results.forEach(result => {
        const syllables = result.syllables;
        if(!bySyllables[syllables]) bySyllables[syllables] = {total:0, correct:0};
        bySyllables[syllables].total++;
        if(result.correct) bySyllables[syllables].correct++;
    });
    const session = {
        id: Date.now(),
        date: new Date().toISOString(),
        totalWords: total,
        correctWords: correct,
        accuracy,
        initialBaseDuration: state.session.initialBaseDuration,
        finalBaseDuration: state.curDur,
        listName: state.session.listName,
        bySyllables
    };
    state.history.unshift(session);
    localStorage.setItem('blitzlesen-history', JSON.stringify(state.history));
    state.screen = 'results';
    render();
}

function togglePause() {
    state.paused = !state.paused;
    if(!state.paused && state.countdown !== null) runCountdown();
    else if(!state.paused && state.showWord) showCurrentWord();
    render();
}

function confirmEnd() {
    if(state.results.length === 0) {
        if(confirm('Noch keine WÃ¶rter bewertet. Wirklich beenden?')) {
            state.screen = 'start';
            render();
        }
    } else {
        finishSession();
    }
}

function exportCSV() {
    const csv = [
        ['Datum', 'Liste', 'Gesamt', 'Richtig', 'Genauigkeit', 'Start-Dauer', 'End-Dauer'],
        ...state.history.map(s => [
            new Date(s.date).toLocaleString('de-DE'),
            s.listName || 'Standard',
            s.totalWords,
            s.correctWords,
            s.accuracy + '%',
            s.initialBaseDuration + 'ms',
            (s.finalBaseDuration || s.initialBaseDuration) + 'ms'
        ])
    ].map(row => row.join(';')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'blitzlesen-verlauf.csv';
    link.click();
}

function createList() {
    if(!state.newListName.trim()) return;
    const newList = {
        id: Date.now().toString(),
        name: state.newListName,
        words: [],
        isDefault: false
    };
    state.lists.push(newList);
    state.activeListId = newList.id;
    state.newListName = '';
    state.showListMgr = false;
    localStorage.setItem('blitzlesen-wordlists', JSON.stringify(state.lists));
    localStorage.setItem('blitzlesen-active-list', newList.id);
    render();
}

function deleteList(listId) {
    if(state.lists.find(l => l.id === listId)?.isDefault) return;
    state.lists = state.lists.filter(list => list.id !== listId);
    if(state.activeListId === listId) {
        state.activeListId = 'default';
        localStorage.setItem('blitzlesen-active-list', 'default');
    }
    localStorage.setItem('blitzlesen-wordlists', JSON.stringify(state.lists));
    render();
}

function switchList(listId) {
    state.activeListId = listId;
    localStorage.setItem('blitzlesen-active-list', listId);
    render();
}

function handleCSVUpload(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        const text = event.target.result;
        const words = text.split(/[\n,;]/).map(w => w.trim()).filter(w => w.length > 0);
        const activeList = state.lists.find(list => list.id === state.activeListId);
        if(activeList) {
            activeList.words = words;
            localStorage.setItem('blitzlesen-wordlists', JSON.stringify(state.lists));
            render();
        }
    };
    reader.readAsText(file);
}

// === RENDER FUNKTIONEN ===
function render() {
    const app = document.getElementById('app');
    const screens = {start: renderStart, settings: renderSettings, training: renderTraining, results: renderResults, history: renderHistory};
    app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-4"><div class="w-full max-w-2xl">${screens[state.screen]()}</div></div>`;
    attachEvents();
}

function renderStart() {
    return `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
    <div class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-indigo-600 mb-3">âš¡ Blitzlesen</h1>
        <p class="text-gray-600 text-lg">Trainiere deine Lesekraft</p>
    </div>
    <div class="space-y-4">
        <button onclick="startSession()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-xl transition-all text-lg shadow-lg">â–¶ Training starten</button>
        <button onclick="toSettings()" class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-semibold py-4 px-6 rounded-xl transition-all text-lg hover:bg-indigo-50">âš™ï¸ Einstellungen</button>
        ${state.history.length > 0 ? `<button onclick="toHistory()" class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-semibold py-4 px-6 rounded-xl transition-all text-lg hover:bg-indigo-50">ğŸ“Š Sessions (${state.history.length})</button>` : ''}
    </div>
</div>`;
}

function renderSettings() {
    return `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-h-[90vh] overflow-y-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Einstellungen</h2>
    <div class="space-y-6 mb-8">
        <div>
            <label class="block text-gray-700 font-semibold mb-3">Basisdauer: <span class="text-indigo-600">${state.settings.baseDuration}ms</span></label>
            <input type="range" min="50" max="500" step="10" value="${state.settings.baseDuration}" id="baseDurationSlider" class="w-full h-3 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
        </div>
        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-xl">
            <div><span class="font-semibold text-gray-700 block">Wort eintippen</span></div>
            <button onclick="toggleSetting('requireTyping')" class="w-14 h-8 rounded-full ${state.settings.requireTyping?'bg-purple-600':'bg-gray-300'}">
                <div class="w-6 h-6 bg-white rounded-full shadow-md transform ${state.settings.requireTyping?'translate-x-7':'translate-x-1'}"></div>
            </button>
        </div>
        <div class="flex items-center justify-between p-4 bg-indigo-50 rounded-xl">
            <span class="font-semibold text-gray-700">WÃ¶rter mischen</span>
            <button onclick="toggleSetting('shuffle')" class="w-14 h-8 rounded-full ${state.settings.shuffle?'bg-indigo-600':'bg-gray-300'}">
                <div class="w-6 h-6 bg-white rounded-full shadow-md transform ${state.settings.shuffle?'translate-x-7':'translate-x-1'}"></div>
            </button>
        </div>
        <div class="flex items-center justify-between p-4 bg-green-50 rounded-xl">
            <div><span class="font-semibold text-gray-700 block">Adaptive Geschwindigkeit</span>
            <span class="text-sm text-gray-500">${state.settings.adaptiveThreshold} richtig â†’ -${state.settings.adaptiveStep}ms</span></div>
            <button onclick="toggleSetting('adaptiveSpeed')" class="w-14 h-8 rounded-full ${state.settings.adaptiveSpeed?'bg-green-600':'bg-gray-300'}">
                <div class="w-6 h-6 bg-white rounded-full shadow-md transform ${state.settings.adaptiveSpeed?'translate-x-7':'translate-x-1'}"></div>
            </button>
        </div>
        ${state.settings.adaptiveSpeed?`<div class="space-y-4 p-4 bg-green-50 rounded-xl border-2 border-green-200">
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Nach X WÃ¶rtern: <span class="text-green-600">${state.settings.adaptiveThreshold}</span></label>
                <input type="range" min="2" max="10" step="1" value="${state.settings.adaptiveThreshold}" id="thresholdSlider" class="w-full h-3 bg-green-200 rounded-lg appearance-none cursor-pointer accent-green-600">
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Delta: <span class="text-green-600">Â±${state.settings.adaptiveStep}ms</span> <span class="text-xs text-gray-500">(bei <120ms halbiert)</span></label>
                <input type="range" min="5" max="50" step="5" value="${state.settings.adaptiveStep}" id="stepSlider" class="w-full h-3 bg-green-200 rounded-lg appearance-none cursor-pointer accent-green-600">
            </div>
        </div>`:''}
        <div>
            <div class="flex items-center justify-between mb-3">
                <label class="font-semibold text-gray-700">ğŸ“š Liste: ${getActive().name}</label>
                <div class="flex gap-2">
                    <button onclick="toggleListMgr()" class="text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1 rounded-lg">Listen verwalten</button>
                    <button onclick="uploadCSV()" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg">ğŸ“¤ CSV</button>
                </div>
            </div>
            ${state.showListMgr?`<div class="mb-4 p-4 bg-indigo-50 rounded-xl border-2 border-indigo-200">
                <h4 class="font-bold text-gray-800 mb-3">Wortlisten-Verwaltung</h4>
                <div class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                    ${state.lists.map(l=>`<div class="flex items-center justify-between p-2 rounded-lg ${state.activeListId===l.id?'bg-indigo-200':'bg-white'}">
                        <button onclick="switchList('${l.id}')" class="flex-1 text-left font-semibold text-gray-700">${l.name} (${l.words.length})</button>
                        ${!l.isDefault?`<button onclick="deleteList('${l.id}')" class="text-red-500 text-sm px-2">LÃ¶schen</button>`:''}
                    </div>`).join('')}
                </div>
                <div class="flex gap-2">
                    <input type="text" id="newListName" placeholder="Neue Liste..." class="flex-1 px-3 py-2 border-2 border-indigo-300 rounded-lg focus:outline-none">
                    <button onclick="createList()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Erstellen</button>
                </div>
            </div>`:''}
            <textarea id="wordArea" class="w-full h-40 p-3 border-2 border-gray-300 rounded-xl focus:outline-none font-mono text-sm">${getActive().words.join('\n')}</textarea>
            <p class="text-xs text-gray-500 mt-1">${getActive().words.length} WÃ¶rter</p>
        </div>
    </div>
    <div class="flex gap-3">
        <button onclick="toStart()" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl">Abbrechen</button>
        <button onclick="startSession()" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg">Los geht's!</button>
    </div>
</div>`;
}

function renderTraining() {
    const tier = getTier(state.curDur);
    let content = '';
    if(state.countdown !== null && state.countdown > 0) {
        content = `<div class="text-9xl font-bold text-indigo-600 animate-pulse">${state.countdown}</div>`;
    } else if(state.showWord) {
        content = `<div class="text-5xl md:text-7xl font-bold text-gray-800 text-center">${state.session.words[state.idx].text}</div>`;
    } else if(state.showBtns) {
        if(state.feedback) {
            content = `<div class="flex flex-col items-center py-12 ${state.feedback==='correct'?'text-green-600':'text-red-600'}">
                <div class="text-9xl mb-4">${state.feedback==='correct'?'ğŸ‘':'ğŸ‘'}</div>
                <div class="text-3xl font-bold">${state.feedback==='correct'?'Richtig!':'Falsch!'}</div></div>`;
        } else if(!state.settings.requireTyping) {
            content = `<div class="w-full max-w-md space-y-4">
                <p class="text-center text-gray-600 text-lg mb-3">Hast du das Wort erkannt?</p>
                <div class="mb-6"><div class="text-center text-gray-500 text-sm mb-2">Wort nochmal anzeigen:</div>
                <div class="group relative bg-gradient-to-br from-gray-400 to-gray-500 hover:from-white hover:to-gray-50 border-2 border-dashed border-gray-600 rounded-xl p-6 cursor-help transition-all">
                    <div class="text-3xl md:text-4xl font-bold text-center">
                        <span class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">${state.session.words[state.idx].text}</span>
                        <span class="absolute inset-0 flex items-center justify-center opacity-100 group-hover:opacity-0 transition-opacity duration-300 text-gray-600 text-base">???</span>
                    </div></div></div>
                <button onclick="handleAnswer(true)" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-8 rounded-xl text-2xl shadow-lg">âœ“ Ja</button>
                <button onclick="handleAnswer(false)" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-6 px-8 rounded-xl text-2xl shadow-lg">âœ— Nein</button>
            </div>`;
        } else {
            content = `<div class="w-full max-w-md space-y-4">
                <p class="text-center text-gray-600 text-lg mb-3">Welches Wort?</p>
                <input type="text" id="wordInput" class="w-full text-2xl text-center p-4 border-4 border-indigo-300 rounded-xl focus:outline-none" placeholder="Wort eingeben...">
                <button onclick="checkTyped()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-6 px-8 rounded-xl text-2xl shadow-lg">PrÃ¼fen</button>
            </div>`;
        }
    }
    return `
<div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
    <div class="bg-gradient-to-r ${tier.c} p-4 text-white">
        <div class="flex items-center justify-center gap-3">
            <span class="text-4xl">${tier.e}</span>
            <div class="text-center"><div class="font-bold text-lg">${tier.n}</div>
            <div class="text-sm opacity-90">${tier.l} â€¢ ${state.curDur}ms</div></div>
            <span class="text-4xl">${tier.e}</span>
        </div>
    </div>
    <div class="min-h-[500px] flex items-center justify-center p-8">${content}</div>
    <div class="bg-gray-50 border-t-2 border-gray-200 p-4">
        <div class="flex gap-2 mb-2">
            <button onclick="toSettings()" class="bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg">âš™ï¸</button>
            <button onclick="togglePause()" class="flex-1 bg-yellow-500 text-white font-semibold py-3 px-4 rounded-lg">${state.paused?'â–¶ Fortsetzen':'â¸ Pause'}</button>
            <button onclick="confirmEnd()" class="flex-1 bg-red-500 text-white font-semibold py-3 px-4 rounded-lg">â¹ Beenden</button>
        </div>
        ${state.settings.adaptiveSpeed?`<div class="text-xs text-gray-600 text-center">Richtig: ${state.consCorrect}/${state.settings.adaptiveThreshold} | Falsch: ${state.consWrong}/${state.settings.adaptiveThreshold}${state.consCorrect>0 && state.consCorrect<state.settings.adaptiveThreshold?` â€¢ Noch ${state.settings.adaptiveThreshold-state.consCorrect} bis zum nÃ¤chsten Tier! ğŸ¯`:''}</div>`:''}
    </div>
</div>`;
}

function renderResults() {
    const latest = state.history[0];
    const tier1 = getTier(latest.initialBaseDuration);
    const tier2 = getTier(latest.finalBaseDuration);
    return `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">ğŸ¯ Geschafft!</h2>
    <div class="text-center mb-6">
        <div class="text-7xl font-bold text-indigo-600 mb-4">${latest.accuracy}%</div>
        <p class="text-xl text-gray-700">${latest.correctWords} von ${latest.totalWords} WÃ¶rtern</p>
        ${latest.initialBaseDuration!==latest.finalBaseDuration?`<div class="mt-4 inline-block">
            <div class="bg-gradient-to-r ${tier2.c} text-white px-6 py-3 rounded-full font-bold shadow-lg">
                <span class="text-2xl mr-2">${tier1.e}</span>${tier1.n} <span class="mx-2">â†’</span>
                <span class="text-2xl mr-2">${tier2.e}</span>${tier2.n}
            </div></div>`:''}
        <p class="text-gray-500 mt-3">Liste: ${latest.listName}<br/>${latest.initialBaseDuration}ms â†’ ${latest.finalBaseDuration}ms</p>
    </div>
    ${latest.bySyllables && Object.keys(latest.bySyllables).length?`<div class="mb-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6 border-2 border-indigo-200">
        <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">ğŸ“Š Nach Silbenzahl</h3>
        <div class="space-y-3">${Object.keys(latest.bySyllables).sort((a,b)=>a-b).map(s=>{
            const d = latest.bySyllables[s];
            const p = Math.round((d.correct/d.total)*100);
            return `<div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-gray-700">${s} Silbe${s>1?'n':''}</span>
                    <span class="text-2xl font-bold text-indigo-600">${p}%</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex-1 bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all" style="width:${p}%"></div>
                    </div>
                    <span class="text-sm text-gray-600 min-w-[60px] text-right">${d.correct}/${d.total}</span>
                </div>
            </div>`;
        }).join('')}</div>
    </div>`:''}
    <div class="space-y-3">
        <button onclick="toStart()" class="w-full bg-indigo-600 text-white font-semibold py-4 px-6 rounded-xl text-lg shadow-lg">ğŸ”„ Neues Training</button>
        <button onclick="toHistory()" class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-semibold py-4 px-6 rounded-xl text-lg">ğŸ“Š Verlauf</button>
    </div>
</div>`;
}

function renderHistory() {
    return `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Trainings-Verlauf</h2>
    <div class="space-y-3 mb-6 max-h-96 overflow-y-auto">
        ${state.history.map(s=>`<div class="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200">
            <div class="flex justify-between items-center">
                <div><p class="font-bold text-lg text-indigo-600">${s.accuracy}%</p>
                <p class="text-sm text-gray-600">${s.correctWords}/${s.totalWords} WÃ¶rter</p></div>
                <div class="text-right"><p class="text-sm text-gray-500">${new Date(s.date).toLocaleDateString('de-DE')}</p>
                <p class="text-xs text-gray-500">${s.listName||'Standard'}</p></div>
            </div>
        </div>`).join('')}
    </div>
    <div class="flex gap-3">
        <button onclick="toStart()" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl">ZurÃ¼ck</button>
        <button onclick="exportCSV()" class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl">CSV Export</button>
    </div>
</div>`;
}

// === EVENT HANDLING ===
function attachEvents() {
    const bd = document.getElementById('baseDurationSlider');
    if(bd) bd.addEventListener('input', e => {state.settings.baseDuration = parseInt(e.target.value); render();});
    const th = document.getElementById('thresholdSlider');
    if(th) th.addEventListener('input', e => {state.settings.adaptiveThreshold = parseInt(e.target.value); render();});
    const st = document.getElementById('stepSlider');
    if(st) st.addEventListener('input', e => {state.settings.adaptiveStep = parseInt(e.target.value); render();});
    const wa = document.getElementById('wordArea');
    if(wa) wa.addEventListener('input', e => {
        const al = state.lists.find(l=>l.id===state.activeListId);
        if(al) {al.words = parse(e.target.value); localStorage.setItem('blitzlesen-wordlists',JSON.stringify(state.lists)); render();}
    });
    const nln = document.getElementById('newListName');
    if(nln) nln.addEventListener('input', e => state.newListName = e.target.value);
    const wi = document.getElementById('wordInput');
    if(wi) {
        wi.addEventListener('input', e => state.typed = e.target.value);
        wi.addEventListener('keypress', e => {if(e.key==='Enter') checkTyped();});
        wi.focus();
    }
    const csv = document.getElementById('csvUpload');
    if(csv) csv.addEventListener('change', handleCSVUpload);
}

function toggleSetting(key) {state.settings[key] = !state.settings[key]; render();}
function toStart() {state.screen = 'start'; render();}
function toSettings() {state.screen = 'settings'; render();}
function toHistory() {state.screen = 'history'; render();}
function checkTyped() {handleTypedSubmit();}
function toggleListMgr() {state.showListMgr = !state.showListMgr; render();}
function uploadCSV() {document.getElementById('csvUpload').click();}

// Initial render
render();
    </script>
</body>
</html>
