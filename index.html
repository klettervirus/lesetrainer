<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blitzlesen-Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 0.7s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>
    <input type="file" id="csvUpload" accept=".csv,.txt" style="display:none">
    
    <script>
const SYLLABLE_DECAY = 0.8;
const DEFAULT_WORDS = ["Haus","Sonne","Blume","Katze","Hund","Baum","Tisch","Stuhl","Buch","Auto","Fenster","Garten","Regen","Wolke","Stern","Vogel","Fisch","Pferd","Apfel","Birne","Erdbeere","Banane","Orange","Tomate","Gurke","Blumentopf","Regenbogen","Schmetterling","Spielplatz","Fahrrad","Computer","Telefon","Tasche","Schere","Klebstoff","Freundschaft","Geburtstag","Weihnachten","Ostern","Ferien","Schwimmbad","Turnhalle","Klassenzimmer","Pausenhof","Bibliothek","Abenteuer","Geschichte","M√§rchen","Dinosaurier","Roboter"];
const ANTI_RATEN = ["deine","deiner","deines","Hund","Hunde","Buch","B√ºcher","Hand","H√§nde","der","die","das","den","denen","des","dies","dessen","denn","Daten","davon"];
const SINGULAR_PLURAL = ["Schiffe","Schiff","Hosen","Hose","Garten","Lieder","Lied","Tische","Tisch","Pflanzen","Pflanze","Papiere","Papier","Namen","Name","Schwestern","Schwester","Zahl","Zahlen","T√ºten","T√ºte","H√§user","Haus","Taschen","Tasche","S√§tze","Satz","Platz","Pl√§tze","Sch√ºsseln","Sch√ºssel","Kreise","Kreis","Wiese","Wiesen","Schuhe","Schuh","Kinder","Kind","K√∂pfe","Kopf","M√§nner","Mann","Haare","Haar"];

let S = {
    screen: 'start',
    set: {baseDuration: 250, shuffle: true, adaptiveSpeed: true, adaptiveThreshold: 2, adaptiveStep: 10, requireTyping: false, customWords: DEFAULT_WORDS.join('\n')},
    lists: [{id:'default',name:'Standard-Wortliste',words:DEFAULT_WORDS,isDefault:true},{id:'anti-raten',name:'Anti Raten',words:ANTI_RATEN,isDefault:false},{id:'singular-plural',name:'Singular/Plural',words:SINGULAR_PLURAL,isDefault:false}],
    activeListId: 'default', showListMgr: false, newListName: '',
    session: null, idx: 0, countdown: null, showWord: false, showBtns: false, paused: false,
    results: [], history: JSON.parse(localStorage.getItem('blitzlesen-history')||'[]'),
    consCorrect: 0, consWrong: 0, curDur: 250, typed: '', feedback: null
};

const saved = localStorage.getItem('blitzlesen-wordlists');
if(saved) S.lists = JSON.parse(saved);
const savedActive = localStorage.getItem('blitzlesen-active-list');
if(savedActive) {
    S.activeListId = savedActive;
    const list = S.lists.find(l=>l.id===savedActive);
    if(list) S.set.customWords = list.words.join('\n');
}

const calcTime = (syl,base) => base*5*(1-Math.pow(SYLLABLE_DECAY,syl));
const getTier = d => {
    if(d<=100) return {n:'Gepard',e:'üêÜ',c:'from-yellow-400 to-orange-500',l:'Blitzschnell!'};
    if(d<=150) return {n:'Hase',e:'üê∞',c:'from-green-400 to-emerald-500',l:'Super schnell!'};
    if(d<=200) return {n:'Pferd',e:'üê¥',c:'from-blue-400 to-cyan-500',l:'Schnell!'};
    if(d<=250) return {n:'Fuchs',e:'ü¶ä',c:'from-orange-400 to-red-500',l:'Flink!'};
    if(d<=300) return {n:'Katze',e:'üêà',c:'from-purple-400 to-pink-500',l:'Geschickt!'};
    if(d<=350) return {n:'Eichh√∂rnchen',e:'üêøÔ∏è',c:'from-amber-400 to-orange-400',l:'Munter!'};
    if(d<=400) return {n:'Igel',e:'ü¶î',c:'from-yellow-300 to-amber-400',l:'Gem√ºtlich'};
    if(d<=450) return {n:'Ente',e:'ü¶Ü',c:'from-blue-300 to-teal-400',l:'Entspannt'};
    return {n:'Koala',e:'üê®',c:'from-gray-300 to-slate-400',l:'Ganz ruhig'};
};
const countSyl = w => {
    const v = w.toLowerCase().replace(/[^a-z√§√∂√º√ü]/g,'').match(/[aeiou√§√∂√ºy]+/g);
    return v?v.length:1;
};
const procWords = wl => wl.map(w=>({text:w, syllables:countSyl(w)}));
const shuffle = a => {
    const s = [...a];
    for(let i=s.length-1;i>0;i--) {
        const j = Math.floor(Math.random()*(i+1));
        [s[i],s[j]] = [s[j],s[i]];
    }
    return s;
};
const parse = t => t.split('\n').map(w=>w.trim()).filter(w=>w.length>0);
const getActive = () => S.lists.find(l=>l.id===S.activeListId)||S.lists[0];

const render = () => {
    const screens = {start:renderStart, settings:renderSettings, training:renderTraining, results:renderResults, history:renderHistory};
    document.getElementById('app').innerHTML = `<div class="min-h-screen flex items-center justify-center p-4"><div class="w-full max-w-2xl">${screens[S.screen]()}</div></div>`;
    attach();
};

const renderStart = () => `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
    <div class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-indigo-600 mb-3">‚ö° Blitzlesen</h1>
        <p class="text-gray-600 text-lg">Trainiere deine Lesekraft</p>
    </div>
    <div class="space-y-4">
        <button data-act="startSession" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-xl transition-all text-lg shadow-lg">‚ñ∂ Training starten</button>
        <button data-act="toSettings" class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-semibold py-4 px-6 rounded-xl transition-all text-lg hover:bg-indigo-50">‚öôÔ∏è Einstellungen</button>
        ${S.history.length?`<button data-act="toHistory" class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-semibold py-4 px-6 rounded-xl transition-all text-lg hover:bg-indigo-50">üìä Sessions (${S.history.length})</button>`:''}
    </div>
</div>`;

const renderSettings = () => `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-h-[90vh] overflow-y-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Einstellungen</h2>
    <div class="space-y-6 mb-8">
        <div>
            <label class="block text-gray-700 font-semibold mb-3">Basisdauer: <span class="text-indigo-600">${S.set.baseDuration}ms</span></label>
            <input type="range" min="50" max="500" step="10" value="${S.set.baseDuration}" data-set="baseDuration" class="w-full h-3 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
        </div>
        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-xl">
            <div><span class="font-semibold text-gray-700 block">Wort eintippen</span></div>
            <button data-act="toggleTyping" class="w-14 h-8 rounded-full ${S.set.requireTyping?'bg-purple-600':'bg-gray-300'}">
                <div class="w-6 h-6 bg-white rounded-full shadow-md transform ${S.set.requireTyping?'translate-x-7':'translate-x-1'}"></div>
            </button>
        </div>
        <div class="flex items-center justify-between p-4 bg-indigo-50 rounded-xl">
            <span class="font-semibold text-gray-700">W√∂rter mischen</span>
            <button data-act="toggleShuffle" class="w-14 h-8 rounded-full ${S.set.shuffle?'bg-indigo-600':'bg-gray-300'}">
                <div class="w-6 h-6 bg-white rounded-full shadow-md transform ${S.set.shuffle?'translate-x-7':'translate-x-1'}"></div>
            </button>
        </div>
        <div class="flex items-center justify-between p-4 bg-green-50 rounded-xl">
            <div><span class="font-semibold text-gray-700 block">Adaptive Geschwindigkeit</span>
            <span class="text-sm text-gray-500">${S.set.adaptiveThreshold} richtig ‚Üí -${S.set.adaptiveStep}ms (halbiert <120ms)</span></div>
            <button data-act="toggleAdaptive" class="w-14 h-8 rounded-full ${S.set.adaptiveSpeed?'bg-green-600':'bg-gray-300'}">
                <div class="w-6 h-6 bg-white rounded-full shadow-md transform ${S.set.adaptiveSpeed?'translate-x-7':'translate-x-1'}"></div>
            </button>
        </div>
        <div><label class="font-semibold text-gray-700">üìö Liste: ${getActive().name}</label>
        <button data-act="toggleListMgr" class="text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1 rounded-lg ml-2">Listen verwalten</button>
        <button data-act="uploadCSV" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg ml-2">üì§ CSV</button>
        ${S.showListMgr?`<div class="mt-4 p-4 bg-indigo-50 rounded-xl border-2 border-indigo-200">
            <h4 class="font-bold text-gray-800 mb-3">Wortlisten-Verwaltung</h4>
            <div class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                ${S.lists.map(l=>`<div class="flex items-center justify-between p-2 rounded-lg ${S.activeListId===l.id?'bg-indigo-200':'bg-white'}">
                    <button data-act="switchList" data-id="${l.id}" class="flex-1 text-left font-semibold text-gray-700">${l.name} (${l.words.length})</button>
                    ${!l.isDefault?`<button data-act="deleteList" data-id="${l.id}" class="text-red-500 text-sm px-2">L√∂schen</button>`:''}
                </div>`).join('')}
            </div>
            <div class="flex gap-2">
                <input type="text" id="newListName" value="${S.newListName}" placeholder="Neue Liste..." class="flex-1 px-3 py-2 border-2 border-indigo-300 rounded-lg focus:outline-none">
                <button data-act="createList" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Erstellen</button>
            </div>
        </div>`:''}
        <textarea id="wordArea" class="w-full h-40 p-3 border-2 border-gray-300 rounded-xl focus:outline-none font-mono text-sm">${S.set.customWords}</textarea>
        <p class="text-xs text-gray-500">${parse(S.set.customWords).length} W√∂rter</p>
        </div>
    </div>
    <div class="flex gap-3">
        <button data-act="toStart" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl">Abbrechen</button>
        <button data-act="startSession" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg">Los geht's!</button>
    </div>
</div>`;

const renderTraining = () => {
    const tier = getTier(S.curDur);
    let content = '';
    if(S.countdown!==null && S.countdown>0) content = `<div class="text-9xl font-bold text-indigo-600 animate-pulse">${S.countdown}</div>`;
    else if(S.showWord) content = `<div class="text-5xl md:text-7xl font-bold text-gray-800">${S.session.words[S.idx].text}</div>`;
    else if(S.showBtns) {
        if(S.feedback) content = `<div class="flex flex-col items-center py-12 ${S.feedback==='correct'?'text-green-600':'text-red-600'}">
            <div class="text-9xl mb-4">${S.feedback==='correct'?'üëç':'üëé'}</div>
            <div class="text-3xl font-bold">${S.feedback==='correct'?'Richtig!':'Falsch!'}</div></div>`;
        else if(!S.set.requireTyping) content = `<div class="w-full max-w-md space-y-4">
            <p class="text-center text-gray-600 text-lg mb-3">Hast du das Wort erkannt?</p>
            <div class="mb-6"><div class="text-center text-gray-500 text-sm mb-2">Wort nochmal anzeigen:</div>
            <div class="relative bg-gradient-to-br from-gray-400 to-gray-500 hover:from-white hover:to-gray-50 border-2 border-dashed border-gray-600 rounded-xl p-6 cursor-help transition-all group">
                <div class="text-3xl md:text-4xl font-bold text-center">
                    <span class="opacity-0 group-hover:opacity-100 transition-opacity">${S.session.words[S.idx].text}</span>
                    <span class="absolute inset-0 flex items-center justify-center opacity-100 group-hover:opacity-0 text-gray-600 text-base">???</span>
                </div></div></div>
            <button data-act="ansCorrect" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-8 rounded-xl text-2xl shadow-lg">‚úì Ja</button>
            <button data-act="ansWrong" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-6 px-8 rounded-xl text-2xl shadow-lg">‚úó Nein</button>
        </div>`;
        else content = `<div class="w-full max-w-md space-y-4">
            <p class="text-center text-gray-600 text-lg mb-3">Welches Wort?</p>
            <input type="text" id="wordInput" value="${S.typed}" placeholder="Wort eingeben..." class="w-full text-2xl text-center p-4 border-4 border-indigo-300 rounded-xl focus:outline-none">
            <button data-act="checkTyped" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-6 px-8 rounded-xl text-2xl shadow-lg">Pr√ºfen</button>
        </div>`;
    }
    return `<div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-gradient-to-r ${tier.c} p-4 text-white">
            <div class="flex items-center justify-center gap-3">
                <span class="text-4xl">${tier.e}</span>
                <div class="text-center"><div class="font-bold text-lg">${tier.n}</div>
                <div class="text-sm opacity-90">${tier.l} ‚Ä¢ ${S.curDur}ms</div></div>
                <span class="text-4xl">${tier.e}</span>
            </div>
        </div>
        <div class="min-h-[500px] flex items-center justify-center p-8">${content}</div>
        <div class="bg-gray-50 border-t-2 p-4">
            <div class="flex gap-2 mb-2">
                <button data-act="toSettings" class="bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg">‚öôÔ∏è</button>
                <button data-act="togglePause" class="flex-1 bg-yellow-500 text-white font-semibold py-3 px-4 rounded-lg">${S.paused?'‚ñ∂ Fortsetzen':'‚è∏ Pause'}</button>
                <button data-act="endTraining" class="flex-1 bg-red-500 text-white font-semibold py-3 px-4 rounded-lg">‚èπ Beenden</button>
            </div>
            ${S.set.adaptiveSpeed?`<div class="text-xs text-gray-600 text-center mt-2">
                Richtig: ${S.consCorrect}/${S.set.adaptiveThreshold} | Falsch: ${S.consWrong}/${S.set.adaptiveThreshold}
                ${S.consCorrect>0 && S.consCorrect<S.set.adaptiveThreshold?` ‚Ä¢ Noch ${S.set.adaptiveThreshold-S.consCorrect} bis zum n√§chsten Tier! üéØ`:''}
            </div>`:''}
        </div>
    </div>`;
};

const renderResults = () => {
    const latest = S.history[0];
    const tier1 = getTier(latest.initialBaseDuration);
    const tier2 = getTier(latest.finalBaseDuration||latest.initialBaseDuration);
    return `<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">üéØ Geschafft!</h2>
        <div class="text-center mb-6">
            <div class="text-7xl font-bold text-indigo-600 mb-4">${latest.accuracy}%</div>
            <p class="text-xl text-gray-700">${latest.correctWords} von ${latest.totalWords} W√∂rtern</p>
            ${latest.initialBaseDuration!==latest.finalBaseDuration?`<div class="mt-4 inline-block">
                <div class="bg-gradient-to-r ${tier2.c} text-white px-6 py-3 rounded-full font-bold shadow-lg">
                    <span class="text-2xl mr-2">${tier1.e}</span>${tier1.n}
                    <span class="mx-2">‚Üí</span>
                    <span class="text-2xl mr-2">${tier2.e}</span>${tier2.n}
                </div></div>`:''}
            <p class="text-gray-500 mt-3">Liste: ${latest.listName||'Standard'}<br/>
            ${latest.initialBaseDuration}ms ‚Üí ${latest.finalBaseDuration||latest.initialBaseDuration}ms</p>
        </div>
        ${latest.bySyllables && Object.keys(latest.bySyllables).length?`<div class="mb-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6 border-2 border-indigo-200">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">üìä Nach Silbenzahl</h3>
            <div class="space-y-3">${Object.keys(latest.bySyllables).sort((a,b)=>a-b).map(s=>{
                const d = latest.bySyllables[s];
                const p = Math.round((d.correct/d.total)*100);
                return `<div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-700">${s} Silbe${s>1?'n':''}</span>
                        <span class="text-2xl font-bold text-indigo-600">${p}%</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all" style="width:${p}%"></div>
                        </div>
                        <span class="text-sm text-gray-600 min-w-[60px] text-right">${d.correct}/${d.total}</span>
                    </div>
                </div>`;
            }).join('')}</div>
        </div>`:''}
        <div class="space-y-3">
            <button data-act="toStart" class="w-full bg-indigo-600 text-white font-semibold py-4 px-6 rounded-xl text-lg shadow-lg">üîÑ Neues Training</button>
            <button data-act="toHistory" class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-semibold py-4 px-6 rounded-xl text-lg">üìä Verlauf</button>
        </div>
    </div>`;
};

const renderHistory = () => `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Trainings-Verlauf</h2>
    <div class="space-y-3 mb-6 max-h-96 overflow-y-auto">
        ${S.history.map(s=>`<div class="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200">
            <div class="flex justify-between items-center">
                <div><p class="font-bold text-lg text-indigo-600">${s.accuracy}%</p>
                <p class="text-sm text-gray-600">${s.correctWords}/${s.totalWords} W√∂rter</p></div>
                <div class="text-right"><p class="text-sm text-gray-500">${new Date(s.date).toLocaleDateString('de-DE')}</p>
                <p class="text-xs text-gray-500">${s.listName||'Standard'}</p></div>
            </div>
        </div>`).join('')}
    </div>
    <div class="flex gap-3">
        <button data-act="toStart" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl">Zur√ºck</button>
        <button data-act="exportCSV" class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-xl">CSV Export</button>
    </div>
</div>`;

const attach = () => {
    document.querySelectorAll('[data-act]').forEach(b=>b.addEventListener('click',e=>{
        const a = e.currentTarget.dataset.act;
        const id = e.currentTarget.dataset.id;
        handle(a,id);
    }));
    document.querySelectorAll('[data-set]').forEach(i=>i.addEventListener('input',e=>{
        S.set[e.target.dataset.set] = parseInt(e.target.value);
        render();
    }));
    const wa = document.getElementById('wordArea');
    if(wa) wa.addEventListener('input',e=>{
        S.set.customWords = e.target.value;
        const al = S.lists.find(l=>l.id===S.activeListId);
        if(al) {
            al.words = parse(e.target.value);
            localStorage.setItem('blitzlesen-wordlists',JSON.stringify(S.lists));
        }
    });
    const nln = document.getElementById('newListName');
    if(nln) nln.addEventListener('input',e=>S.newListName=e.target.value);
    const wi = document.getElementById('wordInput');
    if(wi) {
        wi.addEventListener('input',e=>S.typed=e.target.value);
        wi.addEventListener('keypress',e=>{if(e.key==='Enter')handle('checkTyped');});
        wi.focus();
    }
};

const handle = (a,id) => {
    if(a==='toStart') S.screen='start';
    else if(a==='toSettings') S.screen='settings';
    else if(a==='toHistory') S.screen='history';
    else if(a==='startSession') startSession();
    else if(a==='toggleShuffle') S.set.shuffle=!S.set.shuffle;
    else if(a==='toggleAdaptive') S.set.adaptiveSpeed=!S.set.adaptiveSpeed;
    else if(a==='toggleTyping') S.set.requireTyping=!S.set.requireTyping;
    else if(a==='toggleListMgr') S.showListMgr=!S.showListMgr;
    else if(a==='createList') createList();
    else if(