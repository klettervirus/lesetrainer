<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blitzlesen-Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 0.7s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>
    
    <script>
// KONSTANTEN & WORTLISTEN
const SYLLABLE_DECAY = 0.8;
const DEFAULT_WORDS = ["Haus","Sonne","Blume","Katze","Hund","Baum","Tisch","Stuhl","Buch","Auto","Fenster","Garten","Regen","Wolke","Stern","Vogel","Fisch","Pferd","Apfel","Birne","Erdbeere","Banane","Orange","Tomate","Gurke","Blumentopf","Regenbogen","Schmetterling","Spielplatz","Fahrrad","Computer","Telefon","Tasche","Schere","Klebstoff","Freundschaft","Geburtstag","Weihnachten","Ostern","Ferien","Schwimmbad","Turnhalle","Klassenzimmer","Pausenhof","Bibliothek","Abenteuer","Geschichte","M√§rchen","Dinosaurier","Roboter"];
const ANTI_RATEN = ["deine","deiner","deines","Hund","Hunde","Buch","B√ºcher","Hand","H√§nde","der","die","das","den","denen","des","dies","dessen","denn","Daten","davon"];
const SINGULAR_PLURAL = ["Schiffe","Schiff","Hosen","Hose","Garten","Lieder","Lied","Tische","Tisch","Pflanzen","Pflanze","Papiere","Papier","Namen","Name","Schwestern","Schwester","Zahl","Zahlen","T√ºten","T√ºte","H√§user","Haus","Taschen","Tasche","S√§tze","Satz","Platz","Pl√§tze","Sch√ºsseln","Sch√ºssel","Kreise","Kreis","Wiese","Wiesen","Schuhe","Schuh","Kinder","Kind","K√∂pfe","Kopf","M√§nner","Mann","Haare","Haar"];

let state = {
    screen: 'start',
    settings: {baseDuration: 250, shuffle: true, adaptiveSpeed: true, adaptiveThreshold: 2, adaptiveStep: 10, requireTyping: false},
    lists: [
        {id:'default',name:'Standard-Wortliste',words:DEFAULT_WORDS,isDefault:true},
        {id:'anti-raten',name:'Anti Raten',words:ANTI_RATEN,isDefault:false},
        {id:'singular-plural',name:'Singular/Plural',words:SINGULAR_PLURAL,isDefault:false}
    ],
    activeListId: 'default',
    session: null,
    idx: 0,
    countdown: null,
    showWord: false,
    showBtns: false,
    paused: false,
    results: [],
    history: JSON.parse(localStorage.getItem('blitzlesen-history')||'[]'),
    consCorrect: 0,
    consWrong: 0,
    curDur: 250,
    typed: '',
    feedback: null
};

const saved = localStorage.getItem('blitzlesen-wordlists');
if(saved) state.lists = JSON.parse(saved);
const savedActive = localStorage.getItem('blitzlesen-active-list');
if(savedActive) state.activeListId = savedActive;

// HILFSFUNKTIONEN
const calcTime = (syl, base) => base * 5 * (1 - Math.pow(SYLLABLE_DECAY, syl));
const getTier = d => {
    if(d<=100) return {n:'Gepard',e:'üêÜ',c:'from-yellow-400 to-orange-500',l:'Blitzschnell!'};
    if(d<=150) return {n:'Hase',e:'üê∞',c:'from-green-400 to-emerald-500',l:'Super schnell!'};
    if(d<=200) return {n:'Pferd',e:'üê¥',c:'from-blue-400 to-cyan-500',l:'Schnell!'};
    if(d<=250) return {n:'Fuchs',e:'ü¶ä',c:'from-orange-400 to-red-500',l:'Flink!'};
    if(d<=300) return {n:'Katze',e:'üêà',c:'from-purple-400 to-pink-500',l:'Geschickt!'};
    if(d<=350) return {n:'Eichh√∂rnchen',e:'üêøÔ∏è',c:'from-amber-400 to-orange-400',l:'Munter!'};
    if(d<=400) return {n:'Igel',e:'ü¶î',c:'from-yellow-300 to-amber-400',l:'Gem√ºtlich'};
    if(d<=450) return {n:'Ente',e:'ü¶Ü',c:'from-blue-300 to-teal-400',l:'Entspannt'};
    return {n:'Koala',e:'üê®',c:'from-gray-300 to-slate-400',l:'Ganz ruhig'};
};
const countSyl = w => {
    const v = w.toLowerCase().replace(/[^a-z√§√∂√º√ü]/g,'').match(/[aeiou√§√∂√ºy]+/g);
    return v ? v.length : 1;
};
const procWords = wl => wl.map(w => ({text:w, syllables:countSyl(w)}));
const shuffle = a => {
    const s = [...a];
    for(let i=s.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [s[i],s[j]] = [s[j],s[i]];
    }
    return s;
};
const parse = t => t.split('\n').map(w=>w.trim()).filter(w=>w.length>0);
const getActive = () => state.lists.find(l=>l.id===state.activeListId)||state.lists[0];

function startSession() {
    const words = state.settings.shuffle ? shuffle(procWords(getActive().words)) : procWords(getActive().words);
    state.session = {words, startTime: new Date().toISOString(), initialBaseDuration: state.settings.baseDuration, listName: getActive().name};
    state.idx = 0;
    state.results = [];
    state.consCorrect = 0;
    state.consWrong = 0;
    state.curDur = state.settings.baseDuration;
    state.screen = 'training';
    state.paused = false;
    render();
    startCountdown();
}

function startCountdown() {
    state.countdown = 3;
    state.showWord = false;
    state.showBtns = false;
    state.feedback = null;
    render();
    runCountdown();
}

function runCountdown() {
    if(state.paused) return;
    if(state.countdown > 0) {
        setTimeout(() => {
            state.countdown--;
            render();
            runCountdown();
        }, 700);
    } else {
        showCurrentWord();
    }
}

function showCurrentWord() {
    state.countdown = null;
    state.showWord = true;
    state.typed = '';
    render();
    const word = state.session.words[state.idx];
    const displayTime = calcTime(word.syllables, state.curDur);
    setTimeout(() => {
        if(!state.paused && state.screen === 'training') {
            state.showWord = false;
            state.showBtns = true;
            render();
        }
    }, displayTime);
}

function handleAnswer(correct) {
    state.results.push({word: state.session.words[state.idx].text, correct, baseDuration: state.curDur});
    
    if(state.settings.adaptiveSpeed) {
        if(correct) {
            state.consCorrect++;
            state.consWrong = 0;
            if(state.consCorrect >= state.settings.adaptiveThreshold && state.curDur > 50) {
                const delta = state.curDur < 120 ? state.settings.adaptiveStep * 0.5 : state.settings.adaptiveStep;
                state.curDur = Math.max(50, state.curDur - delta);
                state.consCorrect = 0;
            }
        } else {
            state.consWrong++;
            state.consCorrect = 0;
            if(state.consWrong >= state.settings.adaptiveThreshold && state.curDur < 500) {
                const delta = state.curDur < 120 ? state.settings.adaptiveStep * 0.5 : state.settings.adaptiveStep;
                state.curDur = Math.min(500, state.curDur + delta);
                state.consWrong = 0;
            }
        }
    }
    
    if(state.idx < state.session.words.length - 1) {
        state.idx++;
        state.showBtns = false;
        render();
        startCountdown();
    } else {
        finishSession();
    }
}

function handleTypedSubmit() {
    const correctWord = state.session.words[state.idx].text.toLowerCase();
    const userWord = state.typed.trim().toLowerCase();
    const isCorrect = userWord === correctWord;
    state.feedback = isCorrect ? 'correct' : 'wrong';
    render();
    setTimeout(() => {
        state.feedback = null;
        handleAnswer(isCorrect);
    }, 1000);
}

function finishSession() {
    const correct = state.results.filter(r=>r.correct).length;
    const total = state.results.length;
    const accuracy = Math.round((correct/total)*100);
    const bySyllables = {};
    state.results.forEach(result => {
        const word = state.session.words.find(w=>w.text===result.word);
        const syllables = word.syllables;
        if(!bySyllables[syllables]) bySyllables[syllables] = {total:0, correct:0};
        bySyllables[syllables].total++;
        if(result.correct) bySyllables[syllables].correct++;
    });
    const session = {
        id: Date.now(),
        date: new Date().toISOString(),
        totalWords: total,
        correctWords: correct,
        accuracy,
        initialBaseDuration: state.session.initialBaseDuration,
        finalBaseDuration: state.curDur,
        listName: state.session.listName,
        bySyllables
    };
    state.history.unshift(session);
    localStorage.setItem('blitzlesen-history', JSON.stringify(state.history));
    state.screen = 'results';
    render();
}

function render() {
    const app = document.getElementById('app');
    const screens = {
        start: renderStart,
        training: renderTraining,
        results: renderResults
    };
    app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-4"><div class="w-full max-w-2xl">${screens[state.screen]()}</div></div>`;
    attachEvents();
}

function renderStart() {
    return `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
    <div class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-indigo-600 mb-3">‚ö° Blitzlesen</h1>
        <p class="text-gray-600 text-lg">Trainiere deine Lesekraft</p>
    </div>
    <div class="space-y-4">
        <button onclick="startSession()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-xl transition-all text-lg shadow-lg">‚ñ∂ Training starten</button>
        <p class="text-sm text-gray-500 text-center">Mit ${getActive().name} (${getActive().words.length} W√∂rter)</p>
    </div>
</div>`;
}

function renderTraining() {
    const tier = getTier(state.curDur);
    let content = '';
    
    if(state.countdown !== null && state.countdown > 0) {
        content = `<div class="text-9xl font-bold text-indigo-600 animate-pulse">${state.countdown}</div>`;
    } else if(state.showWord) {
        content = `<div class="text-5xl md:text-7xl font-bold text-gray-800 text-center">${state.session.words[state.idx].text}</div>`;
    } else if(state.showBtns) {
        if(state.feedback) {
            content = `<div class="flex flex-col items-center py-12 ${state.feedback==='correct'?'text-green-600':'text-red-600'}">
                <div class="text-9xl mb-4">${state.feedback==='correct'?'üëç':'üëé'}</div>
                <div class="text-3xl font-bold">${state.feedback==='correct'?'Richtig!':'Falsch!'}</div>
            </div>`;
        } else if(!state.settings.requireTyping) {
            content = `<div class="w-full max-w-md space-y-4">
                <p class="text-center text-gray-600 text-lg mb-3">Hast du das Wort erkannt?</p>
                <div class="mb-6">
                    <div class="text-center text-gray-500 text-sm mb-2">Wort nochmal anzeigen (hovern):</div>
                    <div class="group relative bg-gradient-to-br from-gray-400 to-gray-500 hover:from-white hover:to-gray-50 border-2 border-dashed border-gray-600 rounded-xl p-6 cursor-help transition-all">
                        <div class="text-3xl md:text-4xl font-bold text-center">
                            <span class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">${state.session.words[state.idx].text}</span>
                            <span class="absolute inset-0 flex items-center justify-center opacity-100 group-hover:opacity-0 transition-opacity duration-300 text-gray-600 text-base">???</span>
                        </div>
                    </div>
                </div>
                <button onclick="handleAnswer(true)" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-8 rounded-xl transition-all text-2xl shadow-lg">‚úì Ja, erkannt</button>
                <button onclick="handleAnswer(false)" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-6 px-8 rounded-xl transition-all text-2xl shadow-lg">‚úó Nein</button>
            </div>`;
        } else {
            content = `<div class="w-full max-w-md space-y-4">
                <p class="text-center text-gray-600 text-lg mb-3">Welches Wort?</p>
                <input type="text" id="wordInput" class="w-full text-2xl text-center p-4 border-4 border-indigo-300 rounded-xl focus:outline-none" placeholder="Wort eingeben...">
                <button onclick="checkTyped()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-6 px-8 rounded-xl text-2xl shadow-lg">Pr√ºfen</button>
            </div>`;
        }
    }
    
    return `
<div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
    <div class="bg-gradient-to-r ${tier.c} p-4 text-white">
        <div class="flex items-center justify-center gap-3">
            <span class="text-4xl">${tier.e}</span>
            <div class="text-center">
                <div class="font-bold text-lg">${tier.n}</div>
                <div class="text-sm opacity-90">${tier.l} ‚Ä¢ ${state.curDur}ms</div>
            </div>
            <span class="text-4xl">${tier.e}</span>
        </div>
    </div>
    <div class="min-h-[500px] flex items-center justify-center p-8">${content}</div>
    <div class="bg-gray-50 border-t-2 border-gray-200 p-4">
        <div class="flex gap-2 mb-2">
            <button onclick="togglePause()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg">${state.paused?'‚ñ∂ Fortsetzen':'‚è∏ Pause'}</button>
            <button onclick="confirmEnd()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg">‚èπ Beenden</button>
        </div>
        ${state.settings.adaptiveSpeed?`<div class="text-xs text-gray-600 text-center">Richtig: ${state.consCorrect}/${state.settings.adaptiveThreshold} | Falsch: ${state.consWrong}/${state.settings.adaptiveThreshold}</div>`:''}
    </div>
</div>`;
}

function renderResults() {
    const latest = state.history[0];
    const tier1 = getTier(latest.initialBaseDuration);
    const tier2 = getTier(latest.finalBaseDuration);
    return `
<div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">üéØ Geschafft!</h2>
    <div class="text-center mb-6">
        <div class="text-7xl font-bold text-indigo-600 mb-4">${latest.accuracy}%</div>
        <p class="text-xl text-gray-700">${latest.correctWords} von ${latest.totalWords} W√∂rtern erkannt</p>
        ${latest.initialBaseDuration!==latest.finalBaseDuration?`<div class="mt-4 inline-block">
            <div class="bg-gradient-to-r ${tier2.c} text-white px-6 py-3 rounded-full font-bold shadow-lg">
                <span class="text-2xl mr-2">${tier1.e}</span>${tier1.n} <span class="mx-2">‚Üí</span>
                <span class="text-2xl mr-2">${tier2.e}</span>${tier2.n}
            </div></div>`:''}
        <p class="text-gray-500 mt-3">Liste: ${latest.listName}<br/>${latest.initialBaseDuration}ms ‚Üí ${latest.finalBaseDuration}ms</p>
    </div>
    <div class="space-y-3">
        <button onclick="toStart()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-xl text-lg shadow-lg">üîÑ Neues Training</button>
    </div>
</div>`;
}

function attachEvents() {
    const input = document.getElementById('wordInput');
    if(input) {
        input.addEventListener('input', e => state.typed = e.target.value);
        input.addEventListener('keypress', e => {if(e.key==='Enter') checkTyped();});
        input.focus();
    }
}

function togglePause() {
    state.paused = !state.paused;
    if(!state.paused && state.countdown !== null) runCountdown();
    else if(!state.paused && state.showWord) showCurrentWord();
    render();
}

function confirmEnd() {
    if(state.results.length === 0) {
        if(confirm('Noch keine W√∂rter bewertet. Wirklich beenden?')) {
            state.screen = 'start';
            render();
        }
    } else {
        finishSession();
    }
}

function checkTyped() {
    const correctWord = state.session.words[state.idx].text.toLowerCase();
    const userWord = state.typed.trim().toLowerCase();
    const isCorrect = userWord === correctWord;
    handleTypedSubmit();
}

function toStart() {
    state.screen = 'start';
    render();
}

// Initial render
render();
    </script>
</body>
</html>
